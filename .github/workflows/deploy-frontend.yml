name: Deploy Next.js to cPanel (Node.js)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json','**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          set -e
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit
          else
            npm install
          fi

      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: 'https://swapmylookcom-be-production.up.railway.app/api/v1'
          NEXT_PUBLIC_CONTENTFUL_SPACE_ID: ${{ secrets.NEXT_PUBLIC_CONTENTFUL_SPACE_ID || '' }}
          NEXT_PUBLIC_CONTENTFUL_ACCESS_TOKEN: ${{ secrets.NEXT_PUBLIC_CONTENTFUL_ACCESS_TOKEN || '' }}
          NEXT_PUBLIC_CONTENTFUL_ENVIRONMENT: ${{ secrets.NEXT_PUBLIC_CONTENTFUL_ENVIRONMENT || 'master' }}

      - name: Create deployment package
        run: |
          mkdir -p deploy
          
          # Copy Next.js build output
          cp -r .next deploy/
          cp -r public deploy/ 2>/dev/null || true
          
          # Copy configuration files
          cp package.json deploy/
          cp package-lock.json deploy/ 2>/dev/null || true
          cp next.config.js deploy/ 2>/dev/null || true
          
          # Copy server.js if it exists
          cp server.js deploy/ 2>/dev/null || true
          
          echo "Deployment package created"

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FRONTEND_FTP_HOST }}
          username: ${{ secrets.FRONTEND_FTP_USERNAME }}
          password: ${{ secrets.FRONTEND_FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: deploy/
          server-dir: ./nextjs-app/
          exclude: |
            **/.git*
            **/.github*
            **/.next/cache/**
            **/*.log
            **/node_modules/**

      - name: Deployment summary
        run: |
          echo "ðŸš€ Deployment completed!"
          echo ""
          echo "ðŸ“¦ Next steps on cPanel:"
          echo "1. Log into cPanel"
          echo "2. Go to 'Setup Node.js App'"
          echo "3. Create/Edit your Node.js application"
          echo "4. Run 'npm install --production' in the app directory"
          echo "5. Restart the application"